var g=(d,p,i)=>new Promise((e,f)=>{var _=s=>{try{r(i.next(s))}catch(t){f(t)}},v=s=>{try{r(i.throw(s))}catch(t){f(t)}},r=s=>s.done?e(s.value):Promise.resolve(s.value).then(_,v);r((i=i.apply(d,p)).next())});import{f as F,c as T,a3 as x,a4 as R,a5 as c,V as b,a6 as L,af as V,ai as C,k as B,ao as j,a7 as M}from"./vue-vendor-24c7dc61.js";import{B as N}from"./index-1c3affea.js";import{l as U}from"./page.api-9d0cf9bc.js";import{b3 as z,an as A}from"./antd-vue-vendor-0d72f01e.js";import{s as P}from"./page.data-58dba86c.js";import q from"./DBFormTable-bda07bb7.js";import{a as G,b as H}from"./aggregation.api-c441389c.js";import{j as J,a as K,a_ as Q,l as W}from"./index-831af9dd.js";import"./BasicModal-58413bab.js";import"./useWindowSizeFn-8f085f6f.js";import"./vxe-table-vendor-8813019a.js";const X={name:"DataSourcesModal",components:{BasicModal:N,DBFormTable:q,SmileOutlined:z},emits:["success","register"],setup(d,{emit:p}){const i=F(null),e=F(!1);let f=0;const _=F(!1),{createConfirm:v}=K(),r=F([]),s=F([]);let t=T("formOptions");const[O,{closeModal:S}]=J(o=>g(this,null,function*(){var u;e.value=o.isUpdate,r.value=(u=o.relationForms)!=null&&u.formList?o.relationForms.formList.map(l=>l.value):[],yield w(r.value),Q(i).then(()=>{var l,a;(a=i.value)==null||a.setDataSource((l=o.relationForms)==null?void 0:l.fieldList)})})),k=A(o=>g(this,null,function*(){f+=1;const u=f;t.value=[],_.value=!0;let l=o&&o.length>0?o:"";const a=yield G({keywords:l,pageSize:100});if(a&&a.length>0){if(u!==f)return;t.value=a.map(n=>({label:n.label,value:n.value,fieldOptions:[]})),_.value=!1}}),10);function w(o){o&&o.length>0&&o.forEach(u=>g(this,null,function*(){var l,a;if(t.value.length>0){let n=t.value.filter(m=>m.value==u);if(!((l=n[0])!=null&&l.fieldOptions)||((a=n[0])==null?void 0:a.fieldOptions.length)==0){const m=yield H(u,{subTable:!0});let D=(m==null?void 0:m.fields)||[];D.length>0&&(n[0].fieldOptions=D.map(h=>({title:h.name,value:h.model,type:h.type,options:h==null?void 0:h.options})))}}}))}function E(o){s.value=o}function I(){v({title:"提交",content:"修改数据后会清空已有的字段配置，是否确认修改？",class:"confirm-class",iconType:"warning",onOk:()=>g(this,null,function*(){var a;let o=(a=i.value)==null?void 0:a.tableRef.getTableData();const l=t.value.filter(n=>r.value.find(m=>m===n.value)).map(n=>({label:n.label,value:n.value,fieldOptions:n.fieldOptions}));p("success",{formList:l,fieldList:o||[]}),S()})})}return{list:U,relationFormList:r,formOptions:t,dBFormRef:i,searchFormSchema:P,registerModal:O,relationChange:w,tableChange:E,handleSubmit:I,loading:_,loadData:k}}};const y=d=>(x("data-v-0422ccff"),d=d(),R(),d),Y={class:"relationItem"},Z=y(()=>c("div",{class:"relationTitle"},[c("span",null,"关联表")],-1)),$={style:{"text-align":"center"}},ee=y(()=>c("p",null,"暂无数据",-1)),oe={class:"relationItem"},te={class:"relationTitle"},ae=y(()=>c("span",null,"请选择表单字段关联",-1)),ne={key:0,class:"noForm"},se=y(()=>c("span",null,"请设置关联表单",-1)),le=[se],ie={key:1,class:"editableTable"};function re(d,p,i,e,f,_){const v=b("smile-outlined"),r=b("a-select"),s=b("a-space"),t=b("DBFormTable"),O=b("BasicModal");return L(),V(O,{onRegister:e.registerModal,title:"数据来源",width:700,canFullscreen:!0,destroyOnClose:"",onOk:e.handleSubmit},{default:C(()=>[c("div",Y,[Z,B(s,{direction:"vertical",style:{width:"100%"}},{default:C(()=>[B(r,{value:e.relationFormList,"onUpdate:value":p[0]||(p[0]=S=>e.relationFormList=S),showSearch:"",mode:"multiple",style:{width:"100%"},placeholder:"请选择关联表",options:e.formOptions,"filter-option":!1,"not-found-content":e.loading?void 0:null,onSearch:e.loadData,onChange:e.relationChange},j({_:2},[e.loading?{name:"notFoundContent",fn:C(()=>[c("div",$,[B(v,{style:{"font-size":"20px"}}),ee])]),key:"0"}:void 0]),1032,["value","options","not-found-content","onSearch","onChange"])]),_:1})]),c("div",oe,[c("div",te,[ae,e.relationFormList.length==0?(L(),M("div",ne,le)):(L(),M("div",ie,[B(t,{ref:"dBFormRef",relationFormList:e.relationFormList,onValueChange:e.tableChange},null,8,["relationFormList","onValueChange"])]))])])]),_:1},8,["onRegister","onOk"])}const Be=W(X,[["render",re],["__scopeId","data-v-0422ccff"]]);export{Be as default};
