var M=(e,i,u)=>new Promise((F,n)=>{var I=l=>{try{s(u.next(l))}catch(d){n(d)}},m=l=>{try{s(u.throw(l))}catch(d){n(d)}},s=l=>l.done?F(l.value):Promise.resolve(l.value).then(I,m);s((u=u.apply(e,i)).next())});import{d as x,f as p,r as ee,e as ae,u as r,a3 as te,a4 as se,a5 as k,V as g,a6 as h,af as y,ag as D,ai as t,k as _,E as B,ao as w,a8 as A,a7 as N,F as U,am as z,ak as V,W as $}from"./vue-vendor-24c7dc61.js";import{a6 as ne}from"./antd-vue-vendor-0d72f01e.js";import{B as oe}from"./index-1c3affea.js";import{a7 as re,j as ue,a as le,k as ie,l as de}from"./index-831af9dd.js";import"./BasicModal-58413bab.js";import"./useWindowSizeFn-8f085f6f.js";import"./vxe-table-vendor-8813019a.js";const fe=x({name:"loginSelect",components:{Avatar:ne,BasicModal:oe},emits:["success","register"],setup(e,{emit:i}){const u=re(),{notification:F}=le(),n=p(!1),I=p([]),m=p(""),s=p(!1),l=p([]),d=p(""),E=p(!1),b=p(""),S=p(),f=ee({orgCode:void 0,tenantId:null}),o={maskClosable:!1,closable:!1,canFullscreen:!1,width:"500px",minHeight:20,maxHeight:20},[q,{closeModal:H}]=ue(),P=ae(()=>{if(r(s)&&r(n))return"请选择租户和部门";if(r(s)&&!r(n))return"请选择部门";if(!r(s)&&r(n))return"请选择租户"}),j=p({tenantId:[{required:r(n),type:"number",message:"请选择租户",trigger:"change"}],orgCode:[{required:r(s),message:"请选择部门",trigger:"change"}]}),W={labelCol:{span:4},wrapperCol:{span:18}};function G(a){var C,v;if((C=a.userInfo)!=null&&C.orgCode&&((v=a.userInfo)==null?void 0:v.orgCode)!==""){s.value=!1;return}let c=a.multi_depart;c==0?(F.warn({message:"提示",description:"您尚未归属部门,请确认账号信息",duration:3}),s.value=!1):c==2?(s.value=!0,l.value=a.departs):s.value=!1}function J(a){var C,v;if((C=a.userInfo)!=null&&C.loginTenantId&&((v=a.userInfo)==null?void 0:v.loginTenantId)!==0){n.value=!1;return}let c=a.tenantList;Array.isArray(c)&&(c.length===0?(n.value=!1,u.setTenant(f.tenantId)):c.length===1?(f.tenantId=c[0].id,n.value=!1,u.setTenant(f.tenantId)):(n.value=!0,I.value=c))}function K(){if(r(n)&&!f.tenantId)return m.value="error",!1;if(r(s)&&!f.orgCode)return d.value="error",!1;S.value.validate().then(()=>{O().then(()=>{u.setTenant(f.tenantId),i("success")}).catch(a=>{}).finally(()=>{X()})}).catch(a=>{})}function O(){return new Promise((a,c)=>{if(!r(s)&&!r(n))a();else{let C={orgCode:f.orgCode,loginTenantId:f.tenantId,username:r(b)};ie.put({url:"/sys/selectDepart",params:C}).then(v=>{v.userInfo?(u.setUserInfo(v.userInfo),a()):(Q(v),u.logout(),c())})}})}function Q(a){F.error({message:"登录失败",description:((a.response||{}).data||{}).message||a.message||"请求出现错误，请稍后再试",duration:4})}function X(){H(),L()}function Y(a){return M(this,null,function*(){a&&(b.value=u.username,yield L(),yield G(a),yield J(a),!r(s)&&!r(n)?i("success",u.getUserInfo):E.value=!0),a.isLogin=!1,u.setLoginInfo(a)})}function L(){I.value=[],m.value="",l.value=[],d.value=""}function Z(a){m.value=""}function R(a){d.value=""}return{registerModal:q,visible:E,tenantList:I,isMultiTenant:n,validate_status:m,isMultiDepart:s,departList:l,validate_status1:d,formState:f,rules:j,layout:W,formRef:S,currTitle:P,config:o,handleTenantChange:Z,handleDepartChange:R,show:Y,handleSubmit:K}}});const T=e=>(te("data-v-6e0f5500"),e=e(),se(),e),ce=T(()=>k("span",null,"您隶属于多租户，请选择登录租户",-1)),pe=T(()=>k("span",{style:{color:"#ed6f6f"}},"请选择登录租户",-1)),me=T(()=>k("span",null,"您隶属于多部门，请选择登录部门",-1)),ve=T(()=>k("span",{style:{color:"#ed6f6f"}},"请选择登录部门",-1));function ge(e,i,u,F,n,I){const m=g("a-avatar"),s=g("a-tooltip"),l=g("a-select-option"),d=g("a-select"),E=g("a-form-item"),b=g("a-form"),S=g("a-button"),f=g("BasicModal");return h(),y(f,D(e.config,{onRegister:e.registerModal,title:e.currTitle,wrapClassName:"loginSelectModal",visible:e.visible,"onUpdate:visible":i[2]||(i[2]=o=>e.visible=o)}),{footer:t(()=>[_(S,{onClick:e.handleSubmit,type:"primary"},{default:t(()=>[B("确认")]),_:1},8,["onClick"])]),default:t(()=>[_(b,D({ref:"formRef",model:e.formState,rules:e.rules},e.layout,{colon:!1,class:"loginSelectForm"}),{default:t(()=>[e.isMultiTenant?(h(),y(E,{key:0,name:"tenantId","validate-status":e.validate_status},w({label:t(()=>[_(s,{placement:"topLeft"},{title:t(()=>[ce]),default:t(()=>[_(m,{style:{"background-color":"#87d068"},size:30},{default:t(()=>[B(" 租户 ")]),_:1})]),_:1})]),default:t(()=>[_(d,{value:e.formState.tenantId,"onUpdate:value":i[0]||(i[0]=o=>e.formState.tenantId=o),onChange:e.handleTenantChange,placeholder:"请选择登录租户",class:A({"valid-error":e.validate_status=="error"})},{default:t(()=>[(h(!0),N(U,null,z(e.tenantList,o=>(h(),y(l,{key:o.id,value:o.id},{default:t(()=>[B(V(o.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","onChange","class"])]),_:2},[e.validate_status=="error"?{name:"extra",fn:t(()=>[pe]),key:"0"}:void 0]),1032,["validate-status"])):$("",!0),e.isMultiDepart?(h(),y(E,{key:1,"validate-status":e.validate_status1,colon:!1},w({label:t(()=>[_(s,{placement:"topLeft"},{title:t(()=>[me]),default:t(()=>[_(m,{style:{"background-color":"rgb(104, 208, 203)"},size:30},{default:t(()=>[B(" 部门 ")]),_:1})]),_:1})]),default:t(()=>[_(d,{value:e.formState.orgCode,"onUpdate:value":i[1]||(i[1]=o=>e.formState.orgCode=o),onChange:e.handleDepartChange,placeholder:"请选择登录部门",class:A({"valid-error":e.validate_status1=="error"})},{default:t(()=>[(h(!0),N(U,null,z(e.departList,o=>(h(),y(l,{key:o.orgCode,value:o.orgCode},{default:t(()=>[B(V(o.departName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","onChange","class"])]),_:2},[e.validate_status1=="error"?{name:"extra",fn:t(()=>[ve]),key:"0"}:void 0]),1032,["validate-status"])):$("",!0)]),_:1},16,["model","rules"])]),_:1},16,["onRegister","title","visible"])}const be=de(fe,[["render",ge],["__scopeId","data-v-6e0f5500"]]);export{be as default};
