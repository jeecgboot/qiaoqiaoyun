var w=(e,i,u)=>new Promise((D,h)=>{var m=s=>{try{f(u.next(s))}catch(g){h(g)}},v=s=>{try{f(u.throw(s))}catch(g){h(g)}},f=s=>s.done?D(s.value):Promise.resolve(s.value).then(m,v);f((u=u.apply(e,i)).next())});import{d as X,f as r,r as Z,e as y,w as R,n as B,a3 as Fe,a4 as Se,V as E,a6 as F,a7 as U,F as ee,k as ae,ap as te,aq as oe,ai as ne,ag as se,W as H,a5 as ie,ae as le,af as de}from"./vue-vendor-24c7dc61.js";import{H as o,d as re,c2 as fe,e as ce,b as J,c as ue,cw as ge,k as me,cF as S,r as ve,a as he,cG as Ie,l as ke}from"./index-831af9dd.js";import"./index-1c3affea.js";import De from"./AutoDesformDataFullScreen-bd93fbb9.js";import"./antd-vue-vendor-0d72f01e.js";import"./vxe-table-vendor-8813019a.js";import"./BasicModal-58413bab.js";import"./useWindowSizeFn-8f085f6f.js";const we=X({name:"DesformView",components:{AutoDesformDataFullScreen:De},props:{iframeId:o.string,mode:o.string.isRequired,desformCode:o.string.def(""),dataId:o.string,viewId:o.string,lowAppId:o.string,customButtonId:o.string.def(""),alert:o.bool.def(!0),height:o.string,innerDialog:o.bool.def(!1),eventDialog:o.bool.def(!0),skipPage:o.bool.def(!0),isOnline:o.bool.def(!1),class:o.any,isLinkDialog:o.bool.def(!1),defaultFormData:o.object,widgetConfig:o.array,parentNode:{type:Object},showFooter:o.bool.def(!0),url:o.string.def(""),taskId:o.string.def(""),triggerProcess:o.string.def("")},emits:["reload","success","error","close","force-close","dialogChange"],setup(e,{emit:i}){const{createMessage:u,createErrorModal:D}=he(),{domainUrl:h}=re(),m=r(),v=fe(16),f=r(!1),s=r(!0),g=r(!1),_=r(!1),P=r(!1),C=r(300),I=r(e.desformCode),$=r(0),N=r(""),c=Z({desformCode:"",dataId:"",eventKey:""}),[z,K]=ce(),O=y(()=>e.height||C.value+"px"),b=r([]),V=y(()=>{if(!I.value)return null;let t=e.dataId==null?"add":e.dataId,a;e.isOnline?a=`${h}/desform/${e.mode}/online/${I.value}`:a=`${h}/desform/${e.mode}/${I.value}`,(e.mode==="edit"||e.mode==="detail")&&(a+=`/${t}`),e.url&&e.url.length>0&&(a=e.url),a.indexOf("token=")<0&&(a.indexOf("?")>0?a+=`&token=${J()}`:a+=`?token=${J()}`),a+=`&messageId=${v}`,e.taskId&&a.indexOf("taskId=")<0&&(a+=`&taskId=${e.taskId}`),e.triggerProcess&&a.indexOf("triggerProcess=")<0&&(a+=`&triggerProcess=${e.triggerProcess}`),e.customButtonId&&(a+=`&buttonId=${e.customButtonId}`);let n=ue();return ge(n)||(a+=`&tenantId=${n}`),a+=`&eventDialog=${e.eventDialog}`,a+=`&innerDialog=${e.innerDialog}`,(e.innerDialog||e.skipPage===!1)&&(a+="&skip=false"),a+="&innerRequest=true",a+="&disableScroll=true",a+=`&transparent=${P.value}`,a+=`&showFooter=${e.showFooter}`,a+=`&isLinkDialog=${e.isLinkDialog}`,e.defaultFormData&&(a+=`&defaultFormData=${encodeURIComponent(JSON.stringify(e.defaultFormData))}`),e.widgetConfig&&(a+=`&widgetConfig=${encodeURIComponent(JSON.stringify(e.widgetConfig))}`),e.viewId&&(a+=`&viewId=${e.viewId}`),e.lowAppId&&(a+=`&lowAppId=${e.lowAppId}`),a+=N.value,{src:a,style:{width:"100%",height:O.value,overflow:"hidden",transition:e.height?null:"height 0.3s"},frameborder:"0"}}),j=y(()=>({spinning:s.value||g.value,class:e.class}));R(()=>e.desformCode,()=>I.value=e.desformCode),R(()=>e.parentNode,()=>{P.value=!!e.parentNode},{immediate:!0}),window.addEventListener("message",function(t){let a=t.data;if(`${v}`===a.messageId)switch(a.type){case"close":L();break;case"success":i("success",a.data);break;case"reload":M();break;case"route-jump":G(a.data);break;case"save":x(a.data);break;case"height-change":_.value||(C.value=a.data+10,s.value=!1);break;case"dialog-change":$.value+=a.data?1:-1,i("dialogChange",a.data);break;case"dialog-change-reset":$.value=a.data;break;case"show-message":u[a.data.type](a.data.message);break;case"force-close":i("force-close",a.data);break;case"open-link-form":c.desformCode=a.data.desformCode,c.dataId=a.data.dataId,c.eventKey=a.data.eventKey;break}},!1),setTimeout(()=>{s.value&&(s.value=!1)},6e3);function p(){return w(this,null,function*(){f.value=!0,yield B(),f.value=!1})}R($,(t,a)=>{t===1&&a===0?T(!0):t===0&&a===1&&T(!1)});function T(t){if(!(m.value==null||e.parentNode==null))if(_.value=t,t){let a=m.value.getBoundingClientRect(),n=e.parentNode.getBoundingClientRect(),l={top:e.parentNode.scrollTop,left:e.parentNode.scrollLeft,width:e.parentNode.scrollWidth,height:e.parentNode.scrollHeight},d={top:a.top-n.top+l.top,left:a.left-n.left+l.left};k("body:useRect",{iframeRect:a,parentRect:n,parentScroll:l,relativeRect:d}),setTimeout(()=>b.value=["fullscreen"],2)}else setTimeout(()=>k("body:cancelRect"),198),setTimeout(()=>b.value=[],200)}function x(t){return w(this,null,function*(){let a="/desform/data/add",n="post",l={desformCode:I.value,desformDataJson:JSON.stringify(t.json)};t.onlineForm&&(l.onlineFormCode=t.onlineForm,l.onlineFormDataId=t.onlineDataId),e.dataId!=null&&(a="/desform/data/edit",n="put",l.id=e.dataId),g.value=!0;try{let d=yield me.request({url:a,params:l,method:n},{isTransformResponse:!1});d.success?d.result.customURLFail?(i("error",{res:d}),e.alert&&D({title:"保存失败",content:d.message})):e.isLinkDialog||(i("success",{res:d,dataId:e.dataId}),e.alert&&u.success("保存成功")):(i("error",{res:d}),e.alert&&D({title:"保存失败",content:d.message}))}finally{g.value=!1}})}function L(){i("close")}function M(){i("reload")}function W(t){k("action:submit",t)}function G(t){return w(this,null,function*(){M();let{nextRouteConfig:{routeType:a,routePath:n},dataId:l}=t,d=`?${Ie}=${l}`;a===S.form?(I.value=n,N.value="&"+d.substring(1)):a===S.menu?(yield A(),ve.push(n+d)):a===S.href&&(yield A(),window.open(n+d,"_blank"))})}function A(){return L(),B()}function q(t,a){if(z(t,a),c.desformCode){let n=c.dataId?"edit":"add";K.openModal(!0,{mode:e.mode==="detail"?"detail":n,desformCode:c.desformCode,dataId:c.dataId,isOnline:!1,isLinkDialog:!0})}}function Y(t){let a=t.dataId,{newData:n}=t;k("link-form:success",{dataId:a,newData:n,eventKey:c.eventKey})}function Q(){k("action:print")}function k(t,a={}){var n,l;(l=(n=m.value)==null?void 0:n.contentWindow)==null||l.postMessage({messageId:v,type:t,data:a},"*")}return{iframeRef:m,reload:p,reloading:f,loading:g,pageLoading:s,spinProps:j,getHeight:O,iframeProps:V,iframeClass:b,iframeHeight:C,linkDialog:c,onLinkDialogSuccess:Y,doPrint:Q,sendEvent:k,doActionSubmit:W,registerDataModal:q}}});const Ce=["height","id"];function $e(e,i,u,D,h,m){const v=E("a-spin"),f=E("AutoDesformDataFullScreen");return F(),U(ee,null,[ae(v,te(oe(e.spinProps)),{default:ne(()=>[e.reloading?H("",!0):(F(),U("iframe",se({key:0,ref:"iframeRef",class:e.iframeClass},e.iframeProps,{height:e.height,allow:"geolocation *; microphone *; camera *; midi *; encrypted-media *;",style:{position:"absolute","z-index":"1"},id:e.iframeId}),null,16,Ce)),ie("div",{style:le({height:e.getHeight,position:"relative",zIndex:0})},null,4)]),_:1},16),e.linkDialog.desformCode?(F(),de(f,{key:0,onRegister:e.registerDataModal,onSuccess:e.onLinkDialogSuccess,onClose:i[0]||(i[0]=s=>e.linkDialog.desformCode="")},null,8,["onRegister","onSuccess"])):H("",!0)],64)}const Ae=ke(we,[["render",$e],["__scopeId","data-v-d07ffc7f"]]);export{Ae as default};
