var Y=Object.defineProperty,Z=Object.defineProperties;var ee=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var te=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var R=(o,s,d)=>s in o?Y(o,s,{enumerable:!0,configurable:!0,writable:!0,value:d}):o[s]=d,D=(o,s)=>{for(var d in s||(s={}))te.call(s,d)&&R(o,d,s[d]);if(L)for(var d of L(s))le.call(s,d)&&R(o,d,s[d]);return o},V=(o,s)=>Z(o,ee(s));var A=(o,s,d)=>new Promise((w,m)=>{var K=c=>{try{k(d.next(c))}catch(f){m(f)}},F=c=>{try{k(d.throw(c))}catch(f){m(f)}},k=c=>c.done?w(c.value):Promise.resolve(c.value).then(K,F);k((d=d.apply(o,s)).next())});import{n as oe}from"./antd-vue-vendor-0d72f01e.js";import{d as ie,f as x,r as se,e as z,w as ne,I as ae,a5 as h,V as g,a6 as S,af as re,ai as y,k as p,a7 as T,ak as $,W as j,E as b,F as de,am as ue}from"./vue-vendor-24c7dc61.js";import{B as ce}from"./index-1c3affea.js";import{u as fe}from"./useMethods-f689b480.js";import{s as he}from"./type.definition-4eb605ee.js";import{j as pe,k as ye,l as me}from"./index-831af9dd.js";import"./BasicModal-58413bab.js";import"./useWindowSizeFn-8f085f6f.js";import"./vxe-table-vendor-8813019a.js";const ke=ie({name:"ExportModal",components:{BasicModal:ce,SearchOutlined:oe},props:{designFormCode:{type:String,default:""},viewId:{type:String,default:""},tableColumns:{type:Array,default:()=>[]}},setup(o){let s={},d="";const{handleExportXlsx:w}=fe(),m=x([]),[K,{closeModal:F}]=pe(e=>A(this,null,function*(){q(e.info.columns),s=e.info.queryParams||{},!e.info.idList||e.info.idList.length==0?m.value=[]:m.value=e.info.idList,e.info.name?d=e.info.name:e.info.designFormCode&&(yield k(e.info.designFormCode,e.info.viewName))}));function k(e,l){return A(this,null,function*(){try{const t=`/desform/api/config/${e}`;d=(yield ye.get({url:t})).desformName+"_"+l}catch(t){}})}const c=se({summary:!1,multiSheet:!1,exportType:"xlsx"}),f=x([]),_=x([]),v=x([]),r=x([]),u=x([]),E=z({get(){return{checked:r.value,halfChecked:[]}},set(e){e&&e.checked?r.value=e.checked:r.value=[]}});function q(e){let l=[],t=[],i=[],n=[];for(let a of e)if(!(a.compType=="link-field"&&!a.saveType))if(a.compType==="sub-table-design")i.push({title:a.title,key:a.dataIndex,checked:!0});else if(a.compType==="link-record")if(a.isSubTable===!0)i.push({title:a.title,key:a.dataIndex,checked:!0});else{let B={title:a.title,key:a.key,children:[{title:"标题字段",key:a.key+"_title",disableCheckbox:!0},{title:"记录ID",key:a.key+"_id"}]};n.push(a.key),l.push(B),t.push(a.key),t.push(a.key+"_title")}else l.push({title:a.title,key:a.key}),t.push(a.key);for(let a of he)t.findIndex(B=>B===a.field)>-1||(l.push({title:a.name,key:a.field}),t.push(a.field));l.unshift({title:"记录ID",key:"_id"}),t.push("_id"),t.push("root");const O=[{title:"全选",key:"root",children:l}];f.value=O,v.value=[...n,"root"],r.value=t,_.value=i}const I=x(""),C=z(()=>{let e=f.value,l=I.value;if(!l)return e;let t=[];for(let i of e[0].children)i.title.indexOf(l)>=0&&t.push(D({},i));return[{title:"全选",key:"root",children:t}]});function P(e,l){let t=l.node.dataRef;if(t.key=="root")l.checked===!0?N():r.value=[];else if(l.checked===!0){if(t.children&&t.children.length>0){let i=r.value;i.push(t.children[0].key),r.value=i}}else M()}function M(){let e=r.value,l=e.indexOf("root");l>=0&&e.splice(l,1),r.value=e}function N(){let e=r.value,l=C.value[0].children;for(let t of l)if(e.indexOf(t.key)<0&&e.push(t.key),t.children&&t.children.length>0){let i=t.children[0].key;e.indexOf(i)<0&&e.push(i)}e.push("root"),r.value=e}function H(e,l){if(!l.node.dataRef.disableCheckbox)if(e[0]=="root")l.node.checked===!0?r.value=[]:N();else{let i=r.value;l.node.checked===!0?(i.splice(i.indexOf(e[0]),1),M()):(i.push(e[0]),W(e[0],i)),r.value=i}u.value=[]}function W(e,l){for(let t of C.value[0].children)t.key==e&&t.children&&t.children.length>0&&l.push(t.children[0].key)}function X(){let e=C.value;if(e&&e.length>0){let l=r.value||[];l.checked&&(l=l.checked);let t=0,i=e[0].children;if(l.indexOf("root")>=0)return"("+i.length+"/"+i.length+")";if(i&&i.length>0){for(let n of i)l.indexOf(n.key)>=0&&t++;return"("+t+"/"+i.length+")"}}return""}function G(){let e=f.value,l=[];if(e&&e.length>0){let t=r.value,i=e[0].children,n=!1;t.indexOf("root")>=0&&(n=!0),U(l,i,t,n)}return l.join(",")}function U(e,l,t,i){if(l&&l.length>0)for(let n of l)(i||t.indexOf(n.key)>=0)&&(e.push(n.key),n.children&&l.length>0&&U(e,n.children,t,!1))}function J(){let e=[];if(c.multiSheet===!0){let l=_.value;if(l&&l.length>0)for(let t of l)t.checked===!0&&e.push(t.key)}return e.join(",")}function Q(){const e="/desform/data/lowAppExport/"+s.code;let l=J(),t=G(),i=V(D({},s),{subTables:l,fieldKeyString:t,selectedIds:ae(m.value)});w(d,e,i),F()}return ne(r,()=>{let e=v.value,l=r.value,t=[];for(let n of e)n!="root"&&l.indexOf(n)<0&&t.push(n);if(t.length>0){for(let n of t){let O=e.indexOf(n);e.splice(O,1)}v.value=e}let i=[];for(let n of l)n!="root"&&e.indexOf(n)<0&&i.push(n);if(i.length>0){for(let n of C.value[0].children)n.children&&n.children.length>0&&i.indexOf(n.key)>=0&&e.push(n.key);v.value=e}},{deep:!0}),{registerModal:K,closeModal:F,doExport:Q,treeData:C,expandedKeys:v,checkedKeys:r,selectedKeys:u,searchText:I,onSelect:H,onCheck:P,showStatus:c,subTableList:_,getCountText:X,checkedNewKeys:E}}}),ve={style:{width:"100%",position:"relative"}},xe={style:{position:"absolute",right:"30px","z-index":"999"}},ge={style:{"max-height":"300px","overflow-y":"auto",position:"relative"}},Fe={key:0,style:{position:"absolute",left:"85px",top:"1px","font-size":"14px","z-index":"999",color:"rgb(158, 158, 158)"}},_e={style:{"margin-top":"10px",padding:"0 20px"}},Ce=h("div",{style:{"font-size":"13px",color:"#757575"}},"其他",-1),Se={style:{"margin-top":"10px"}},be={style:{"margin-top":"10px"}},we={key:0,style:{"margin-top":"10px","margin-left":"20px"}},Ke={style:{"margin-top":"10px",padding:"0 20px"}},Te=h("div",{style:{"font-size":"13px",color:"#757575"}},"导出格式",-1),Ee={style:{"margin-top":"10px"}};function Oe(o,s,d,w,m,K){const F=g("SearchOutlined"),k=g("a-input"),c=g("a-tree"),f=g("a-checkbox"),_=g("a-radio"),v=g("a-radio-group"),r=g("BasicModal");return S(),re(r,{title:"将视图下数据导出为 Excel",onRegister:o.registerModal,width:470,canFullscreen:!1,destroyOnClose:"",closable:"",onOk:o.doExport},{default:y(()=>[h("div",ve,[h("div",xe,[p(k,{placeholder:"搜索字段名称",value:o.searchText,"onUpdate:value":s[0]||(s[0]=u=>o.searchText=u)},{prefix:y(()=>[p(F,{style:{color:"#c0c0c0"}})]),_:1},8,["value"])]),h("div",ge,[o.treeData?(S(),T("div",Fe,$(o.getCountText()),1)):j("",!0),p(c,{checkable:"","tree-data":o.treeData,selectedKeys:o.selectedKeys,"onUpdate:selectedKeys":s[1]||(s[1]=u=>o.selectedKeys=u),checkedKeys:o.checkedNewKeys,"onUpdate:checkedKeys":s[2]||(s[2]=u=>o.checkedNewKeys=u),expandedKeys:o.expandedKeys,"onUpdate:expandedKeys":s[3]||(s[3]=u=>o.expandedKeys=u),checkStrictly:"",onCheck:o.onCheck,onSelect:o.onSelect},null,8,["tree-data","selectedKeys","checkedKeys","expandedKeys","onCheck","onSelect"])]),h("div",_e,[Ce,h("div",Se,[p(f,{checked:o.showStatus.summary,"onUpdate:checked":s[4]||(s[4]=u=>o.showStatus.summary=u),disabled:""},{default:y(()=>[b("列统计结果")]),_:1},8,["checked"])]),h("div",be,[p(f,{checked:o.showStatus.multiSheet,"onUpdate:checked":s[5]||(s[5]=u=>o.showStatus.multiSheet=u)},{default:y(()=>[b("在其他sheet导出关联表")]),_:1},8,["checked"])]),o.showStatus.multiSheet?(S(),T("div",we,[(S(!0),T(de,null,ue(o.subTableList,u=>(S(),T("div",null,[p(f,{checked:u.checked,"onUpdate:checked":E=>u.checked=E},{default:y(()=>[b($(u.title),1)]),_:2},1032,["checked","onUpdate:checked"])]))),256))])):j("",!0)]),h("div",Ke,[Te,h("div",Ee,[p(v,{value:o.showStatus.exportType,"onUpdate:value":s[6]||(s[6]=u=>o.showStatus.exportType=u)},{default:y(()=>[p(_,{value:"xlsx"},{default:y(()=>[b("Excel 文件（.xlsx）")]),_:1}),p(_,{value:"csv",style:{"margin-left":"10px"},disabled:""},{default:y(()=>[b("CSV 文件（.csv）")]),_:1})]),_:1},8,["value"])])])])]),_:1},8,["onRegister","onOk"])}const ze=me(ke,[["render",Oe]]);export{ze as default};
