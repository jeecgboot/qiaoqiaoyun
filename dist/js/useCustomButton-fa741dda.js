var X=Object.defineProperty,Y=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var U=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var V=(e,i,o)=>i in e?X(e,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[i]=o,F=(e,i)=>{for(var o in i||(i={}))_.call(i,o)&&V(e,o,i[o]);if(U)for(var o of U(i))ee.call(i,o)&&V(e,o,i[o]);return e},$=(e,i)=>Y(e,Z(i));var f=(e,i,o)=>new Promise((g,y)=>{var A=k=>{try{B(o.next(k))}catch(I){y(I)}},R=k=>{try{B(o.throw(k))}catch(I){y(I)}},B=k=>k.done?g(k.value):Promise.resolve(k.value).then(A,R);B((o=o.apply(e,i)).next())});import{f as M,c as j,w as te,I as D,p as ne}from"./vue-vendor-24c7dc61.js";import{a as se,a7 as oe,k as w}from"./index-831af9dd.js";import{u as ae}from"./LinkRecordSelect-385d0eae.js";import{u as re}from"./lowAppAuth-3d637b7d.js";const p={save:"/desform/button/save",update:"/desform/button/update",remove:"/desform/button/remove",list:"/desform/button/list",checkOnly:"/desform/button/checkOnly",queryById:"/desform/button/queryById",resetSequence:"/desform/button/resetSequence",removeRelation:"/desform/button/removeRelation",addRelation:"/desform/button/addRelation",addLinkRecordRelationData:"/desform/button/addLinkRecordRelationData",checkAddable:"/desform/button/checkAddable",translateCondition:"/desform/button/translateCondition",processInfo:"/act/designer/miniDesFlow/api/getProcess",buttonStartProcess:"/act/designer/miniDesFlow/api/buttonStartProcess"},G="globalButtonList";function fe(e,i,o,g){const y=M([]);let A=j(G,void 0),R=j("globalColumnList",void 0);const{ifTrue:B,ifGroupTrue:k}=ae(),I=re();te(()=>e.dynamicConfig,()=>{let n=e.dynamicConfig,s=(n==null?void 0:n.buttonList)||[];y.value=s},{immediate:!0,deep:!0});function S(n,s,r){return n===!0||Object.keys(s).indexOf(r)<0?!0:s[r]}function P(n,s){if(!s||!s.value)return[];let r=s.value.filter(t=>t.allView===!0),l=y.value;if(l=l.concat(r.map(t=>t.id)),l.length==0)return[];let u=s.value;if(u.length==0)return[];let h=D(u);h.sort(function(t,C){return C.seq-t.seq});let d=[],m=I.getLowAppAdminAuth(),L=I.getCustomButtonAuth(o.value);for(let t of h)if(l.indexOf(t.id)>=0){if(S(m,L,t.id)===!1)continue;if(c(t,n)){const T={label:t.label,icon:t.icon,tooltip:t.note,iconColor:t.color};if(t.clickThen==="confirm"){const{tip:v,ok:Q,cancel:W}=t.confirmText;T.popConfirm={title:v,okText:Q,cancelText:W,confirm:()=>{O(n,t.processId)}}}else if(t.clickThen==="form"){let v=t.buttonFormConfig;v.formTable==="current"&&v.formType==="create"?T.onClick=()=>{E(n,v,t.label,t.id,t)}:v.formTable==="link-record"&&v.formType==="create"?T.onClick=()=>{H(n,v,t.label,t.id,t)}:T.onClick=()=>{K(n,v,t.label,t.id,t)}}else T.onClick=()=>{O(n,t.processId)};d.push(T)}}return d}function c(n,s){if(n.showStatus==="condition"){const{conditionList:r,conditionsGroup:l,conditionType:u}=n;return Array.isArray(r)&&r.length>0?B(r,u,s):k(l,u,s)}return!0}const{createErrorModal:a,createMessage:b}=se(),q=oe();function O(n,s,r){return f(this,null,function*(){if(s){let l=o.value,u={processId:s,dataId:n.id,formKey:l,applyUserId:q.getUserInfo.username};const h=yield w.post({url:p.buttonStartProcess,params:u},{joinParamsToUrl:!0,isTransformResponse:!1});h.success?r===!0||b.success("操作成功！"):b.warn(h.message)}else b.warn("未配置流程！")})}function K(n,s,r,l,u){let h=!1,d=o.value,m=n.id;if(s.formTable==="link-record"&&(h=!0,R)){let t=R.value.filter(C=>C.key===s.linkRecordField);if(t&&t.length>0){let{model:C,name:T}=t[0],v=n[C];if(v&&v.length>0)d=s.linkRecordTable,m=D(v)[0];else{a({title:`无法执行按钮“${r}”`,content:`“${T}”为空，请关联操作后再执行按钮操作`,okButtonProps:{danger:!0}});return}}}i.openModal(!0,{mode:"edit",desformCode:d,dataId:m,isOnline:!1,isLinkRecordForm:h,customButtonId:l,currentRecordId:n.id,viewId:e.viewId,lowAppId:g==null?void 0:g.value,flowStatus:u.flowStatus,processId:u.processId,hideCustomButton:!0})}function E(n,s,r,l,u){if(R){let d=R.value.filter(m=>m.key===s.createFormField);if(d&&d.length>0){let{model:m,multi:L,name:t}=d[0];if(L===!1)if(n[m]){a({title:`无法执行按钮“${r}”`,content:`“${t}”已有关联记录，无法重复添加`,okButtonProps:{danger:!0}});return}else x(s.createFormCode,l,n.id,u);else x(s.createFormCode,l,n.id,u)}}}function H(n,s,r,l,u){return f(this,null,function*(){if(R){let d=R.value.filter(m=>m.key===s.linkRecordField);if(d&&d.length>0){let{model:m,name:L}=d[0],t=n[m];if(t){if(t&&t.length>0){let C=D(t)[0];(yield J(l,C))?x(s.createFormCode,l,n.id,u,C):a({title:`无法执行按钮“${r}”`,content:`“${L}”已有关联记录，无法重复添加`,okButtonProps:{danger:!0}})}}else a({title:`无法执行按钮“${r}”`,content:`“${L}”为空，请关联操作后再执行按钮操作`,okButtonProps:{danger:!0}})}}})}function z(n,s,r){return f(this,null,function*(){let l={currentRecordId:n,linkRecordDataId:s,buttonId:r,designFormCode:o.value};const u=yield w.post({url:p.addLinkRecordRelationData,params:l},{isTransformResponse:!1});u.success||b.warn(u.message)})}function J(n,s){return f(this,null,function*(){let r={buttonId:n,linkRecordId:s};return(yield w.get({url:p.checkAddable,params:r},{isTransformResponse:!1})).result})}function x(n,s,r,l,u){i.openModal(!0,{mode:"add",desformCode:n,dataId:null,isOnline:!1,isLinkRecordForm:!0,customButtonId:s,currentRecordId:r,flowStatus:l.flowStatus,processId:l.processId,linkRecordId:u||""})}function N(n){let s=[],r=I.getLowAppAdminAuth(),l=I.getCustomButtonAuth(e.designFormCode),u=n.filter(d=>d.allView===!0);if(u&&u.length>0)for(let d of u)S(r,l,d.id)!==!1&&s.push(F({},d));let h=y.value;if(h.length==0)return[];for(let d of n)if(h.indexOf(d.id)>=0){if(S(r,l,d.id)===!1)continue;s.push(F({},d))}return s.sort(function(d,m){return m.seq-d.seq}),s}return{designButtonList:A,getCustomButtons:P,addLinkRecordData:z,getBatchRowCustomButtons:N,executeFlow:O}}function me(){const e=M([]);ne(G,e);function i(o){if(!o||o.length==0)e.value=[];else{let g=[];for(let y of o)g.push(F({},y));e.value=g}}return{initButtonList:i}}function we(e){function i(c){return f(this,null,function*(){let a=$(F({},c),{designFormCode:e.code,viewId:e.viewId});return yield w.post({url:p.save,params:a},{isTransformResponse:!1})})}function o(c){return f(this,null,function*(){let a=$(F({},c),{designFormCode:e.code,viewId:e.viewId});yield w.post({url:p.update,params:a},{isTransformResponse:!1})})}function g(c){return f(this,null,function*(){let a={buttonId:c,designFormCode:e.code};yield w.delete({url:p.remove,data:a},{joinParamsToUrl:!0})})}function y(c){return f(this,null,function*(){let a={buttonId:c,viewId:e.viewId};yield w.delete({url:p.removeRelation,data:a},{joinParamsToUrl:!0})})}function A(c){return f(this,null,function*(){let a={id:c,viewId:e.viewId};yield w.post({url:p.addRelation,params:a},{isTransformResponse:!1})})}function R(){return f(this,null,function*(){let c={designFormCode:e.code};const a=yield w.get({url:p.list,params:c},{isTransformResponse:!1});return a.success?a.result:[]})}function B(){return f(this,null,function*(){let c={designFormCode:e.code,viewId:e.viewId};const a=yield w.get({url:p.list,params:c},{isTransformResponse:!1});return a.success?a.result:[]})}function k(c,a){return f(this,null,function*(){let b={id:c,label:a,designFormCode:e.code,viewId:e.viewId};const q=yield w.get({url:p.checkOnly,params:b},{isTransformResponse:!1});return q.success?q.result:!1})}function I(c){return f(this,null,function*(){yield w.post({url:p.resetSequence,params:{list:c}},{isTransformResponse:!1})})}function S(c){return f(this,null,function*(){let a={list:c,code:e.code};const b=yield w.post({url:p.translateCondition,params:a},{isTransformResponse:!1});return b.success?b.result:[]})}function P(c){return f(this,null,function*(){const a=yield w.get({url:p.processInfo,params:{processId:c}},{isTransformResponse:!1});return a.success?a.result:{}})}return{queryDesignButtonList:R,queryViewButtonList:B,removeButton:g,saveButton:i,updateButton:o,resetSequence:I,checkOnlyButtonLabel:k,removeRelation:y,addRelation:A,translateCondition:S,getProcessInfo:P}}function pe(e,i){if(!Array.isArray(e)||e.length==0)return[];if(e[0].matchType==null){let g=[];return g.push({matchType:i!=null?i:"and",queryItems:[...e]}),g}else return e}export{pe as a,me as b,fe as c,we as u};
